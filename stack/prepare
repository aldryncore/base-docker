#!/bin/bash
#
# Prepares the "stack" to run apps and the environment to run buildpacks
#

SCRIPT=$(readlink -f "$0")
BASEDIR=$(dirname "$SCRIPT")

#
# SYSTEM PACKAGES
#
apt-get update
xargs apt-get install -y --force-yes < /stack/packages.txt
apt-get clean

#
# MISC
#

# install latest pip
curl --silent --show-error --retry 5 https://bootstrap.pypa.io/get-pip.py | sudo python2.7

# install forego (a foreman clone in go)
curl --silent --show-error --retry 5 -o /usr/local/bin/forego https://godist.herokuapp.com/projects/ddollar/forego/releases/current/linux-amd64/forego
chmod u+x /usr/local/bin/forego

# cleanup
rm -rf /var/lib/apt/lists/*
apt-get clean

# make node available with its default name
ln -s /usr/bin/nodejs /usr/bin/node

# workaround for a bug in hub.docker.com
ln -s -f /bin/true /usr/bin/chfn

# copy our custom commands
cp ${BASEDIR}/start /usr/local/bin/start
ln -nsf /usr/local/bin/start /start
cp ${BASEDIR}/run-forest-run /usr/local/bin/run-forest-run
